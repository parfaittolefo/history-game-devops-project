node {
    //Code pull from github
  stage('SCM (Get the source code from Git)') {
    checkout scm
  }

   //Environment 

    environment {
	    APP_NAME = "history-game-devops-project-pipeline"
            RELEASE = "1.0.0"
            DOCKER_USER = "hack2k21"
            DOCKER_PASS = 'dockerhub'
            IMAGE_NAME = "${DOCKER_USER}" + "/" + "${APP_NAME}"
            IMAGE_TAG = "${RELEASE}-${BUILD_NUMBER}"
	    JENKINS_API_TOKEN = credentials("JENKINS_API_TOKEN")
    }


    //code analysis with sonarqube
  stage('SonarQube Analysis') {
    def scannerHome = tool 'SonarScanner';
    withSonarQubeEnv() {
      sh "${scannerHome}/bin/sonar-scanner"
    }
  }
    
    // Code vulnerabily scan with OWASP ZAP TOP 10

     stage('Dependancy-Vuln check OWASP') {

    dependencyCheck additionalArguments: '--format=HTML', odcInstallation: 'OWASP-ZAP-DP'
  }


// Depoeiment on test env
 stage('Deploiement on test env)') {

   sh 'cd Docker-preprod && sudo docker compose up -d'
  }

//Run test 

 stage('Tests Runing') {
    //sh "cd /var/www/html/ && rm -rf history-game-devops-project; git clone https://github.com/parfaittolefo/history-game-devops-project.git"
    sh "composer update --lock --ignore-platform-reqs"
    sh "composer install --optimize-autoloader --ignore-platform-reqs"
    sh "php8.1 vendor/bin/codecept run --steps --debug --html"
   
    
}

//Publish report

  stage('Generating Allure Reports') {
        allure([
            includeProperties: false,
            jdk: '',
            properties: [],
            reportBuildPolicy: 'ALWAYS',
            results: [[path: 'tests/_output/allure-results']]
        ])
    }

//Build  prod docker image

/*stage("Build & Push Docker Image") {
          
                script {
                    docker.withRegistry('',DOCKER_PASS) {
                    docker_image = docker.build "${IMAGE_NAME}"
                    }

                    docker.withRegistry('',DOCKER_PASS) {
                    docker_image.push("${IMAGE_TAG}")
                    docker_image.push('latest')
                    }
                }
            
            }*/

docker.withRegistry('', DOCKER_PASS) {
                def docker_image = docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
                docker_image.push()
                docker_image.push("latest")}
   
}