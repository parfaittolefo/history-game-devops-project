node {
    //Code pull from github
  /*stage('SCM (Get the source code from Git)') {
    checkout scm
  }

   //Environment 
    environment {
      APP_NAME = "history-game-devops-project-prod"
      RELEASE = "1.0.0"
      DOCKER_USER = "hack2k21"
      IMAGE_NAME = "hack2k21/history-game-devops-project-prod"
    }

    //code analysis with sonarqube
  stage('SonarQube Analysis') {
    def scannerHome = tool 'SonarScanner';
    withSonarQubeEnv() {
      sh "${scannerHome}/bin/sonar-scanner"
    }
  }
    
    // Code vulnerabily scan with OWASP ZAP TOP 10

     stage('Dependancy-Vuln check OWASP') {

    dependencyCheck additionalArguments: '--format=HTML', odcInstallation: 'OWASP-ZAP-DP'
  }


// Depoeiment on test env
 stage('Deploiement on test env)') {

   sh 'cd Docker-preprod && sudo docker compose up -d'
  }

//Run test 

 stage('Tests Runing') {
    //sh "cd /var/www/html/ && rm -rf history-game-devops-project; git clone https://github.com/parfaittolefo/history-game-devops-project.git"
    sh "composer update --lock --ignore-platform-reqs"
    sh "composer install --optimize-autoloader --ignore-platform-reqs"
    sh "php8.1 vendor/bin/codecept run --steps --debug --html"
   
    
}

//Publish report

  stage('Generating Allure Reports') {
        allure([
            includeProperties: false,
            jdk: '',
            properties: [],
            reportBuildPolicy: 'ALWAYS',
            results: [[path: 'tests/_output/allure-results']]
        ])
    }
*/
// Set env var in bash
stage("Set bash env var")
{
  //sh "export APP_NAME='history-game-devops-project-prod'"
  //sh "export RELEASE='1.0.0'"
  sh "export DOCKER_USER='hack2k21'"
  sh "echo User: $DOCKER_USER"
  sh "export IMAGE_NAME=$DOCKER_USER/$APP_NAME"
  sh "export IMAGE_TAG=$RELEASE-$BUILD_NUMBER"
  sh "export IMAGE_REPOS='devops-thesis-project'"

  sh 'printenv'
}
//Build  prod docker image

stage('Build & push prod docker image'){


        
            
            sh "echo APP_NAME $APP_NAME and BUILD_NUMBER $BUILD_NUMBER"
            //sh "echo APP_NAME 2 $APP_NAME"
            sh 'printenv'
        
            sh "docker build -t ${IMAGE_NAME} ."
            sh "docker logout"

           withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOKER_USER')]) {
            
              sh "sudo docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}"
              sh "docker tag ${IMAGE_NAME}:latest ${DOCKER_USER}/${IMAGE_REPOS}:${IMAGE_TAG}"
              sh "sudo docker push ${DOCKER_USER}/${IMAGE_REPOS}:${IMAGE_TAG}"

          } 
        }

/*stage('Build & push prod docker image'){
            sh 'docker build -t history-game-devops-project-prod .'
            sh 'docker logout'

           withCredentials([usernamePassword(credentialsId: 'dockerhub', passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOKER_USER')]) {
            
              sh 'sudo docker login -u hack2k21 -p ${DOCKER_PASS}'
              sh 'docker tag history-game-devops-project-prod:latest hack2k21/devops-thesis-project:v1'
              sh 'sudo docker push hack2k21/devops-thesis-project:v1'

          } 
        }*/
//Docker image scanning with trivy
 stage("Trivy Image Scan") {
             steps {
                 script {
	              sh ("docker run -v /var/run/docker.sock:/var/run/docker.sock trivy image ${DOCKER_USER}/${IMAGE_REPOS}:${IMAGE_TAG} --no-progress --scanners vuln  --exit-code 0 --severity HIGH,CRITICAL --format table > trivyimage.txt")
                 }
             }
         }


//Cleanup Artifacts
stage ('Cleanup Artifacts') {
             
          sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG}"
          sh "docker rmi ${IMAGE_NAME}:latest"
             
         }
}