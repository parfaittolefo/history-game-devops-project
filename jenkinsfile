node {
    //Code pull from github
  stage('SCM (Get the source code from Git)') {
    checkout scm
  }

    //code analysis with sonarqube
  stage('SonarQube Analysis') {
    def scannerHome = tool 'SonarScanner';
    withSonarQubeEnv() {
      sh "${scannerHome}/bin/sonar-scanner"
    }
  }
    
    // Code vulnerabily scan with OWASP ZAP TOP 10

     stage('Dependancy-Vuln check OWASP') {

    dependencyCheck additionalArguments: '--format=HTML', odcInstallation: 'OWASP-ZAP-DP'
  }


//Run test 

 stage('Tests Runing') {
    sh " echo `pwd`"
    sh "composer update --lock --ignore-platform-reqs"
    sh "composer install --optimize-autoloader --ignore-platform-reqs"
    sh "codecept  --no-redirect run --steps  --html "
   
    
}

//Publish report

  /*stage('Generating Reports') {
        allure([
            includeProperties: false,
            jdk: '',
            properties: [],
            reportBuildPolicy: 'ALWAYS',
            results: [[path: 'allure-results']]
        ])
    }
}*/


stage('Generate Allure Report') { steps { script { ws('/var/lib/jenkins/workspace/history-game-devops-project-pipeline') { allure([ includeProperties: false, jdk: '', properties: [], reportBuildPolicy: 'ALWAYS', results: [[path: 'allure-results']] ]) } } } }
